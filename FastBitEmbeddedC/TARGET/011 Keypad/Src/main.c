/**
  ******************************************************************************
  * @file    main.c
  * @author  Auto-generated by STM32CubeIDE
  * @version V1.0
  * @brief   Default main function.
  ******************************************************************************
*/

#include<stdint.h>
#include<stdio.h>

void delay(void);
void ledblink(void);

//peripheral register addresses
uint32_t volatile *const pGPIOAModeReg  =  (uint32_t*)(0x40020000);
uint32_t volatile *const pGPIOBModeReg  =  (uint32_t*)(0x40020400);
uint32_t volatile *const pInPutDataReg  =  (uint32_t*)(0x40020400+0x10);
uint32_t volatile *const pOutPutDataReg =  (uint32_t*)(0x40020000+0x14);
uint32_t volatile *const pClockCtrlReg  =  (uint32_t*)(0x40023830);
uint32_t volatile *const pPullupDownReg =  (uint32_t*)(0x40020400 + 0x0C);


int main(void)
{


	//1.Enable the peripheral clock of GPIOD peripheral
	*pClockCtrlReg |= ( 1 << 0);
	*pClockCtrlReg |= ( 1 << 1);

	printf("Printf Enabled");

    // 2.configure PA7,PA8,PA9,PA10 as output (rows)
	*pGPIOAModeReg &= ~(1 << 10); //clear
	*pGPIOAModeReg &= ~(1 << 11); //clear
	*pGPIOAModeReg &= ~(1 << 19); //clear
	*pGPIOAModeReg &= ~(1 << 18); //clear
	*pGPIOAModeReg &= ~(1 << 15); //clear
	*pGPIOAModeReg &= ~(1 << 14); //clear
	*pGPIOAModeReg &= ~(1 << 21); //clear
	*pGPIOAModeReg &= ~(1 << 20); //clear
	*pGPIOAModeReg &= ~(1 << 17); //clear
	*pGPIOAModeReg &= ~(1 << 16); //clear

	*pGPIOAModeReg |= (1 << 10); //set
	*pGPIOAModeReg |= (1 << 18); //set
	*pGPIOAModeReg |= (1 << 14); //set
	*pGPIOAModeReg |= (1 << 20); //set
	*pGPIOAModeReg |= (1 << 16); //set

	//*pGPIODModeReg |= 0x55;   //set


	// 3. configure PB3 , PB4, PB5, PB10 as input (columns)
	*pGPIOBModeReg &= ~(1 << 6); //clear
	*pGPIOBModeReg &= ~(1 << 7); //clear
	*pGPIOBModeReg &= ~(1 << 8); //clear
	*pGPIOBModeReg &= ~(1 << 9); //clear
	*pGPIOBModeReg &= ~(1 << 10); //clear
	*pGPIOBModeReg &= ~(1 << 11); //clear
	*pGPIOBModeReg &= ~(1 << 20); //clear
	*pGPIOBModeReg &= ~(1 << 21); //clear

	// 4.Enable internal pull-up resistors for PB3 , PB4, PB5, PB10
    *pPullupDownReg &= ~(0xFF << 16);
    *pPullupDownReg |=  (0x55 << 16);

	*pPullupDownReg &= ~(1 << 6); //clear
	*pPullupDownReg &= ~(1 << 7); //clear
	*pPullupDownReg &= ~(1 << 8); //clear
	*pPullupDownReg &= ~(1 << 9); //clear
	*pPullupDownReg &= ~(1 << 10); //clear
	*pPullupDownReg &= ~(1 << 11); //clear
	*pPullupDownReg &= ~(1 << 20); //clear
	*pPullupDownReg &= ~(1 << 21); //clear

	*pPullupDownReg |= (1 << 6);  //set
	*pPullupDownReg |= (1 << 8);  //set
	*pPullupDownReg |= (1 << 10); //set
	*pPullupDownReg |= (1 << 20); //set



	while(1)
	{
	    //make all rows HIGH PA7,PA8,PA9,PA10
		*pOutPutDataReg |= (1 << 7); //set
		*pOutPutDataReg |= (1 << 8); //set
		*pOutPutDataReg |= (1 << 9); //set
		*pOutPutDataReg |= (1 << 10); //set


	    //make R1 LOW (PA9)
	    *pOutPutDataReg &= ~( 1 << 9);

			//scan the columns
			//check C1 (PB3) low or high
			if(!(*pInPutDataReg & ( 1 << 3))){
				//key is pressed
				delay();
				ledblink();
				printf("1\n");
			}

			//check C2 (PB5) low or high
			if(!(*pInPutDataReg & ( 1 << 5))){
				//key is pressed
				delay();
				ledblink();
				printf("2\n");
			}

			//check C3 (PB4) low or high
			if(!(*pInPutDataReg & ( 1 << 4))){
				//key is pressed
				delay();
				ledblink();
				printf("3\n");
			}

			//check C4 (PB10) low or high
			if(!(*pInPutDataReg & ( 1 << 10))){
				//key is pressed
				delay();
				ledblink();
				printf("A\n");
			}

			//make all rows HIGH
			*pOutPutDataReg |= (1 << 7); //set
			*pOutPutDataReg |= (1 << 8); //set
			*pOutPutDataReg |= (1 << 9); //set
			*pOutPutDataReg |= (1 << 10); //set


		//make R2 LOW (PA7)
		*pOutPutDataReg &= ~( 1 << 7);

			//scan the columns
			//check C1 (PB3) low or high
			if(!(*pInPutDataReg & ( 1 << 3))){
				//key is pressed
				delay();
				ledblink();
				printf("1\n");
			}

			//check C2 (PB5) low or high
			if(!(*pInPutDataReg & ( 1 << 5))){
				//key is pressed
				delay();
				ledblink();
				printf("5\n");
			}

			//check C3 (PB4) low or high
			if(!(*pInPutDataReg & ( 1 << 4))){
				//key is pressed
				delay();
				ledblink();
				printf("6\n");
			}

			//check C4 (PB10) low or high
			if(!(*pInPutDataReg & ( 1 << 10))){
				//key is pressed
				delay();
				ledblink();
				printf("B\n");
			}

			//make all rows HIGH
			*pOutPutDataReg |= (1 << 7); //set
			*pOutPutDataReg |= (1 << 8); //set
			*pOutPutDataReg |= (1 << 9); //set
			*pOutPutDataReg |= (1 << 10); //set


		//make R3 LOW (PA10)
		*pOutPutDataReg &= ~( 1 << 10);

			//scan the columns
			//check C1 (PB3) low or high
			if(!(*pInPutDataReg & ( 1 << 3))){
				//key is pressed
				delay();
				ledblink();
				printf("7\n");
			}

			//check C2 (PB5) low or high
			if(!(*pInPutDataReg & ( 1 << 5))){
				//key is pressed
				delay();
				ledblink();
				printf("8\n");
			}

			//check C3 (PB4) low or high
			if(!(*pInPutDataReg & ( 1 << 4))){
				//key is pressed
				delay();
				ledblink();
				printf("9\n");
			}

			//check C4 (PB10) low or high
			if(!(*pInPutDataReg & ( 1 << 10))){
				//key is pressed
				delay();
				ledblink();
				printf("C\n");
			}

			//make all rows HIGH
			*pOutPutDataReg |= (1 << 7); //set
			*pOutPutDataReg |= (1 << 8); //set
			*pOutPutDataReg |= (1 << 9); //set
			*pOutPutDataReg |= (1 << 10); //set


		//make R4 LOW (PA8)
		*pOutPutDataReg &= ~( 1 << 8);

			//scan the columns
			//check C1 (PB3) low or high
			if(!(*pInPutDataReg & ( 1 << 3))){
				//key is pressed
				delay();
				ledblink();
		    	printf("*\n");
			}

			//check C2 (PB5) low or high
			if(!(*pInPutDataReg & ( 1 << 5))){
				//key is pressed
				delay();
				ledblink();
		    	printf("0\n");
			}

			//check C3 (PB4) low or high
			if(!(*pInPutDataReg & ( 1 << 4))){
				//key is pressed
				delay();
				ledblink();
		    	printf("#\n");
			}

			//check C4 (PB10) low or high
			if(!(*pInPutDataReg & ( 1 << 10))){
				//key is pressed
				delay();
				ledblink();
		    	printf("D\n");
			}

			//make all rows HIGH
			*pOutPutDataReg |= (1 << 7); //set
			*pOutPutDataReg |= (1 << 8); //set
			*pOutPutDataReg |= (1 << 9); //set
			*pOutPutDataReg |= (1 << 10); //set

	}
}

void ledblink(void)
{
	*pOutPutDataReg |= (1 << 5); //set
	for (uint32_t i = 0; i < 100000; i++); //Small human observable delay
	*pOutPutDataReg &= ~(1 << 5); //set
	for (uint32_t i = 0; i < 100000; i++); //Small human observable delay
}


void delay(void)
{
	for(uint32_t i =0 ; i < 300000 ; i++);

}

